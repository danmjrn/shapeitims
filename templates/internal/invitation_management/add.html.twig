{% extends 'internal_admin.html.twig' %}

{% block title %}{{ 'Lesy & Lens\'s Invitation Management System | Invitation Management - Add Invitees' }}{% endblock %}

{% block body %}
    <div class="content-body">
        <div class="container-fluid">
            <div class="page-titles">
                <h4>{{ 'Invitation Management - Add Invitees' }}</h4>
            </div>
            <!-- row class="form-valide" -->
            <div class="row">
                <div class="col-xl-12 col-xxl-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">{{ 'Add Invitees' }}</h4>
                            <a href="{{ path('import_invitees') }}"
                               class="btn btn-primary btn-sm">
                                {{ 'Import Invitees' }}
                            </a>
                        </div>
                        <div class="card-body">
                            <div id="addInviteesWizard" class="form-wizard order-create">
                                <ul class="nav nav-wizard">
                                    <li><a class="nav-link" href="#inviteeType" >
                                            <span>1</span>
                                        </a>
                                    </li>
                                    <li><a class="nav-link" href="#enterDetails">
                                            <span>2</span>
                                        </a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div id="inviteeType" class="tab-pane" role="tabpanel" aria-labelledby="inviteeType">
                                        <form class="form-valide" method="get" name="inviteesForm" id="inviteeTypeForm" novalidate>
                                            <div class="row emial-setup">
                                                <div class="col-lg-4 col-sm-12 col-12">
                                                    <div class="form-group">
                                                        <label for="singleType" class="mailclinet mailclinet-gmail selected">
                                                            <input type="radio" name="singleType" id="singleType" value="1">
                                                            <span class="mail-icon">
                                                                    <i class="mdi mdi-account" aria-hidden="true"></i>
                                                                </span>
                                                            <span class="mail-text">{{ 'Single' }}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 col-sm-12 col-12">
                                                    <div class="form-group">
                                                        <label for="coupleType" class="mailclinet mailclinet-office">
                                                            <input type="radio" name="coupleType" id="coupleType" value="2">
                                                            <span class="mail-icon">
                                                                    <i class="mdi mdi-account-multiple" aria-hidden="true"></i>
                                                                </span>
                                                            <span class="mail-text">{{ 'Couple' }}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4 col-sm-12 col-12">
                                                    <div class="form-group">
                                                        <label for="customType" class="mailclinet mailclinet-drive">
                                                            <input type="radio" name="customType" id="customType" value="3">
                                                            <span class="mail-icon">
                                                                    <i class="mdi mdi-account-multiple-plus" aria-hidden="true"></i>
                                                                </span>
                                                            <span class="mail-text">{{'Family/Group'}}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row" id="customNumber">
                                                <div class="col-12 col-sm-12 mb-2 text-center mt-4 mb-4">
                                                    <h3>{{ 'Add the number of guests you would like to add' }}</h3>
                                                    <div class="form-group mt-4" style="padding: 0 20% 0 20%">
                                                        <input class="form-control" value="3" min="3" max="50" type="number" name="numOfInvitees" id="numOfInvitees">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div id="enterDetails" class="tab-pane" role="tabpanel" aria-labelledby="inviteeType">
                                        <form class="form-valide" method="get" name="inviteesForm" id="enterDetailsForm" novalidate>

                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-success" id="btnFinish" disabled>{{ 'Create Invitation' }}</button>
                                <button class="btn btn-danger" id="btnCancel" onclick="{{ 'window.location.href="'~path('invitation_management')~'"' }}">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary shadow btn-xs sharp mr-1"
                    type="button"
                    data-toggle="modal"
                    data-target="{{ '#successMessageModal' }}"
                    hidden
                    id="successMessageBtn"
            >
                <i class="fa fa-pencil"></i>
            </button>
            <div class="modal fade" id="{{ 'successMessageModal' }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ 'Success' }}</h5>
                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success solid alert-dismissible fade show">
                                <p id="{{ 'successMessage' }}"></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary">Add another</button>
                            <button type="button" class="btn btn-danger light dismissMessage" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary shadow btn-xs sharp mr-1"
                    type="button"
                    data-toggle="modal"
                    data-target="{{ '#unsuccessfulMessageModal' }}"
                    hidden
                    id="unsuccessfulMessageBtn"
            >
                <i class="fa fa-pencil"></i>
            </button>
            <div class="modal fade" id="{{ 'unsuccessfulMessageModal' }}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ 'Failed' }}</h5>
                            <button type="button" class="close" data-dismiss="modal"><span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger solid alert-dismissible fade show">
                                <p id="{{ 'unsuccessfulMessage' }}"></p>
                                <p>Check all fields and try again</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary">Try again</button>
                            <button type="button" class="btn btn-danger light dismissMessage" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}

    <script src="{{ asset('build/vendor/jquery-steps/build/jquery.steps.min.js') }}"></script>
    <!-- Jquery Validation -->
    <script src="{{ asset('build/vendor/jquery-validation/jquery.validate.min.js') }}"></script>
    <!-- Form validate init -->
    <script src="{{ asset('build/js/plugins-init/jquery.validate-init.js') }}"></script>
    <!-- Form Steps -->
    <script src="{{ asset('build/vendor/jquery-smartwizard/dist/js/jquery.smartWizard.js') }}"></script>

    <script>

        $(document).ready(function() {
            let $addInviteesWizard = $('#addInviteesWizard');
            let $forms = $addInviteesWizard.find('form');
            let $customNumber = $('#customNumber');
            // SmartWizard initialize
            $addInviteesWizard.smartWizard();
            $customNumber.css('display','none');

            let invitationType = '1';
            let numOfInvitees = '1';

            let $labels = $('#inviteeTypeForm label');
            let activeLabel = $labels[0];

            let $dismissMessage = $('.dismissMessage');

            function createInvitations( data ) {
                let url = '{{ path('create_invitation') }}';

                $.ajax
                (
                    {
                        url: url,
                        type: 'GET',
                        headers:
                            {
                                Accept: 'application/json'
                            },
                        data: data,
                        beforeSend: function () {

                        },
                        success: function (data) {
                            if
                            (
                                data.success &&
                                data.hasOwnProperty('message')
                            )
                                showSuccessfulMessage(data.message);
                            else
                                showUnsuccessfulMessage(data.message);

                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            // console.log('failed');
                        },
                        ajaxComplete: function () {

                        }
                    }
                );
            }

            function validateForm(){
                $forms = $addInviteesWizard.find('form');
                let data = {};
                let formIsValid = true;
                for( let i = 1 ; i <= numOfInvitees; i++ ){
                    let datum = [];
                     $($forms[1]).find('input').each(
                        function () {
                            if (
                                ( $(this).attr('id').includes('firstName') && $(this).val() === '') ||
                                ( $(this).attr('id').includes('lastName') && $(this).val() === '') ||
                                ( $(this).attr('id').includes('title') && $(this).val() === '')
                            )
                                return formIsValid = false;
                            else {
                                if ( $(this).attr('id').includes('-' + String(i)) )
                                    datum.push( {'name': $(this).attr('id'), 'val': $(this).val()} );

                                return formIsValid = true;
                            }
                        }
                    );
                    let selectInvFrom = $($forms[1]).find('select.invFrom')[i-1];
                    let selectInviteeLang = $($forms[1]).find('select.inviteeLang')[i-1];

                    if ($(selectInvFrom).length > 0)
                        datum.push( {'name': $(selectInvFrom).attr('id'), 'val': $(selectInvFrom).val()} );

                    if ($(selectInviteeLang).length > 0)
                        datum.push( {'name': $(selectInviteeLang).attr('id'), 'val': $(selectInviteeLang).val()} );

                    datum.push( {'name': `invitationType-${i}`, 'val': parseInt(invitationType) } );

                    data[`person-${i}`] = datum;
                }

                return [formIsValid, data ];
            }

            function populateInviteePersons (num = 1) {
                $($forms[1]).empty();
                if($forms[1]){
                    for( let i=0; i < num; i++ ){
                        let htmlContent = `
<div class="row">
    <div class="col-12">
        <h4>Person ${ i+1 }:</h4>
    </div>
</div>
<div class="row">
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label class="text-label">First Name (required)</label>
            <input type="text" name="firstName-${i+1}" class="form-control" id="firstName-${i+1}" placeholder="Please enter a firstname" required>
            <div class="valid-feedback">
                Looks good!
            </div>
            <div class="invalid-feedback">
                Please enter a firstname
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label class="text-label">Last Name (required)</label>
            <input type="text" name="lastName-${i+1}" class="form-control" id="lastName-${i+1}" placeholder="Please enter a lastname" required>
            <div class="valid-feedback">
                Looks good!
            </div>
            <div class="invalid-feedback">
                Please enter a lastname
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label class="text-label">Title (required)</label>
            <input type="text" name="title-${i+1}" class="form-control" id="title-${i+1}" placeholder="Please enter a title" required>
            <div class="valid-feedback">
                Looks good!
            </div>
            <div class="invalid-feedback">
                Please enter a title
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label class="text-label">Email (optionl)</label>
            <input type="email" class="form-control" id="email-${i+1}" aria-describedby="email-${i+1}" placeholder="Please enter an email">
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label class="text-label">Phone Number (optional)</label>
            <input type="text" name="phoneNumber-${i+1}" id="phoneNumber-${i+1}" class="form-control" placeholder="Please enter a phone number">
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label>Select list (select one):</label>
            <select class="form-control default-select invFrom" id="invFrom-${i+1}">
                <option value="Bride">Bride</option>
                <option value="Groom">Groom</option>
            </select>
        </div>
    </div>
    <div class="col-lg-6 mb-2">
        <div class="form-group">
            <label>Select list (select one):</label>
            <select class="form-control default-select inviteeLang" id="inviteeLang-${i+1}">
                <option value="en">English</option>
                <option value="fr">French</option>
            </select>
        </div>
    </div>
</div>
                    `;
                        // console.log();
                        $($forms[1]).html($($forms[1]).html() + htmlContent);
                    }
                }
                $addInviteesWizard.smartWizard('reset');
            }

            function showSuccessfulMessage(message){
                let $messageModalBtn = $('#successMessageBtn')
                let $message = $('#successMessage');
                if ($message.length > 0)
                    $message.html(`
<svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
<strong>Success! </strong>${message}`
                    );

                if ($messageModalBtn.length > 0)
                    $messageModalBtn.trigger('click');
            }

            function showUnsuccessfulMessage(message){
                let $messageModalBtn = $('#unsuccessfulMessageBtn')
                let $message = $('#unsuccessfulMessage');
                if ($message.length > 0)
                    $message.html(`
<svg viewBox="0 0 24 24" width="24 " height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
<strong>Error! </strong> ${message}`
                    );

                if ($messageModalBtn.length > 0)
                    $messageModalBtn.trigger('click');
            }

            populateInviteePersons(1);

            $addInviteesWizard.on("showStep", function(e, anchorObject, stepIndex, stepDirection, stepPosition) {
                $('button.sw-btn-prev').removeClass('disabled').prop('disabled', false);
                $('button.sw-btn-next').removeClass('disabled').prop('disabled', false);
                if(stepPosition === 'first') {
                    $('button.sw-btn-prev').addClass('disabled').prop('disabled', true);
                } else if(stepPosition === 'last') {
                    $('button.sw-btn-next').addClass('disabled').prop('disabled', true);
                } else {
                    $('button.sw-btn-prev').removeClass('disabled').prop('disabled', false);
                    $('button.sw-btn-next').removeClass('disabled').prop('disabled', false);
                }

                if (stepPosition === 'last') {
                    $("#btnFinish").prop('disabled', false);
                } else {
                    $("#btnFinish").prop('disabled', true);
                }
            });

            $labels.click(
                function (){
                    if (this !== activeLabel){
                        if ($(activeLabel).hasClass('selected')){
                            $(activeLabel).removeClass('selected');
                            activeLabel = this;
                            $(activeLabel).addClass('selected');
                            invitationType = $(activeLabel).children('input').attr('value');
                        }
                    }
                    if (invitationType === '3') {
                        $customNumber.css('display', 'block');

                        let $numOfInvitees = $('#numOfInvitees');

                        numOfInvitees = $numOfInvitees.val();
                        populateInviteePersons(parseInt(numOfInvitees));

                        $numOfInvitees.change(
                            function () {
                                numOfInvitees = $(this).val();
                                populateInviteePersons(parseInt(numOfInvitees));
                            }
                        );
                    }
                    else {
                        $customNumber.css('display', 'none');
                        numOfInvitees = invitationType;
                        populateInviteePersons(parseInt(numOfInvitees));
                    }
                }
            );

            $('#btnFinish').click(
                function () {
                    if( validateForm()[0] )
                        createInvitations( {persons: validateForm()[1]} )
                    ;
                }
            );

            $dismissMessage.click(
                function () {
                    window.location.href = '{{ path('invitation_management') }}';
                }
            );
        });
    </script>
{% endblock %}
